fastlane_require 'json'

platform :ios do
  desc "Test Slack thread message and file upload"
  lane :test_slack_upload do
    # –ü—É—Ç—å –¥–æ –ª—é–±–æ–≥–æ —Ñ–∞–π–ª–∞ –¥–ª—è —Ç–µ—Å—Ç–∞ (–º–æ–∂–Ω–æ .txt)
    test_file_path = "../readme.md" # –∏–ª–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    slack_response = slack(
      channel: "#bot-test",
      slack_url: "https://hooks.slack.com/services/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",
      message: "üß™ –õ–æ–ª –∫–µ–∫ –æ—Ç Fastlane",
      success: true,
      default_payloads: []
    )

    # –ë–µ—Ä–µ–º ts –∏ channel –∏–∑ JSON –æ—Ç–≤–µ—Ç–∞
    ts = slack_response[:json]["ts"]
    channel = slack_response[:json]["channel"]

    # –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º —Ñ–∞–π–ª –≤ —Ç—Ä–µ–¥
    Actions::Slack.actions_client.files_upload(
      channels: channel,
      thread_ts: ts,
      initial_comment: "üìé –ü—Ä–∏–ª–æ–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª",
      file: Faraday::UploadIO.new(test_file_path, 'text/plain')
    )
  end
end
